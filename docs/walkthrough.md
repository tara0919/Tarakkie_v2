# Tarakkie_v2 プロトタイプ検証ガイド

このガイドでは、Tarakkie_v2のファームウェアとハードウェアを使って動作確認を行うための手順を解説します。

## 1. ハードウェア組み立てガイド

### ベースボード（左右本体）の配線
**Seeed XIAO nRF52840** と **MCP23017 IOエキスパンダ** を以下のように接続してください：

| 信号名 | Xiao BLE ピン | MCP23017 ピン | 注意点 |
| :--- | :--- | :--- | :--- |
| **SDA** | D4 | 13 (SDA) | **3.3Vへのプルアップ抵抗(4.7kΩ)が必須** |
| **SCL** | D5 | 12 (SCL) | **3.3Vへのプルアップ抵抗(4.7kΩ)が必須** |
| **INT** | - | 20 (INTA) | オプション（省電力割り込み用） |
| **VCC** | 3V3 | 9 (VDD) | |
| **GND** | GND | 10 (VSS) | 15,16,17ピン(A0,A1,A2)もGNDにつなぐこと |
| **Reset**| - | 18 (RESET) | **3.3Vに接続** (プルアップ) |

**キーマトリクスとMCP23017の接続:**
- **行 (Rows)**: GPB0 - GPB5 (ピン 1-8)
- **列 (Cols)**: GPA0 - GPA4 (ピン 21-25)

### モジュール1の配線 (トラックボール + エンコーダ)
ポゴピンを経由して、モジュールとXiao BLEを以下のように接続します：

| 部品 | 信号名 | Xiao BLE ピン | 配線メモ |
| :--- | :--- | :--- | :--- |
| **トラックボール** | SCK | D8 | SPI クロック |
| (PMW3610) | MISO | D9 | SPI データOut |
| | MOSI | D10 | SPI データIn |
| | CS | D6 | チップセレクト |
| | MOT (INT)| D7 | モーション割り込み |
| **エンコーダ** | A | D2 | |
| | B | D3 | |
| **スイッチ** | SW | D1 | エンコーダのプッシュボタン |

## 2. ファームウェアの書き込み手順
1.  [GitHub Actions のページ](https://github.com/tara0919/Tarakkie_v2/actions) を開きます。
2.  一番上の最新の「Build」をクリックします。
3.  画面下部の **Artifacts** にある `firmware.zip` をダウンロードします。
4.  解凍すると `tarakkie_v2_left-xiao_ble-zmk.uf2` と `tarakkie_v2_right-xiao_ble-zmk.uf2` が入っています。
5.  Xiao BLE をPCに接続し、自身のリセットボタンを素早く2回押してブートローダーモード（ドライブ名 `XIAO-SENSE`）にします。
6.  対応する側の `.uf2` ファイルをドライブにドラッグ＆ドロップします。

## 3. テスト手順
1.  **接続確認**: キーボードがPCとBluetooth（またはUSB）で接続できるか確認します。
2.  **キー入力テスト**: MCP23017の行ピンと列ピンをショートさせて、キー入力が反応するか確認します。
3.  **モジュールテスト**:
    -   エンコーダを回す -> PageUp / PageDown（初期設定）が反応するか？
    -   トラックボールを動かす -> マウスカーソルが動くか？
    -   エンコーダを押し込む -> 'A'キー（プレースホルダー）が入力されるか？

## 4. 他のモジュールへの切り替え方
モジュール2, 3, 4 を使いたい場合の手順：
1.  `config/boards/shields/tarakkie_v2/tarakkie_v2_left.overlay` を開きます。
2.  現在有効になっている「Module 1」の部分をコメントアウトします (`/* ... */`)。
3.  当該モジュールのスニペットファイル（例：`module_2_snippet.dtsi`）の中身をコピーして貼り付けます。
4.  保存してGitHubへプッシュすると、新しい設定でビルドされます。
